<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #1a237e; --secondary: #2e7d32; --bg: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        
        /* Header */
        .header { background: var(--primary); color: white; padding: 25px; text-align: center; border-bottom: 5px solid var(--secondary); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header h2 { margin: 0; font-size: 1.4rem; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        
        /* Card Style */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Inputs */
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-group label { display: block; font-size: 0.85rem; color: #444; margin-bottom: 6px; font-weight: bold; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 1rem; -webkit-appearance: none; transition: border 0.2s; }
        .form-group input:focus { border-color: var(--primary); outline: none; }
        .required-mark { color: red; margin-left: 3px; }

        /* Table Style */
        .table-header { display: flex; gap: 10px; margin-bottom: 8px; font-size: 0.8rem; color: #777; font-weight: bold; padding: 0 5px; }
        .lbl-firma { flex: 3; }
        .lbl-betrag { flex: 1; text-align: right; }

        .entry-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .entry-num { font-size: 0.8rem; color: #bbb; width: 15px; }
        
        /* CUSTOM INPUT SIZES */
        .inp-firma { 
            flex: 3; 
            padding: 12px; /* Comfortable padding */
            height: 50px;  /* Taller width */
            border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; 
        }
        .inp-betrag { 
            flex: 1; 
            padding: 5px; 
            height: 38px; /* Shorter height as requested */
            text-align: right; font-weight: bold; 
            border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;
        }

        /* Calculation Section */
        .calc-box { background: #e8f5e9; padding: 15px; border-radius: 12px; border: 1px solid #c8e6c9; }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .calc-row label { font-weight: 600; color: var(--primary); }
        .calc-row input { width: 100px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; text-align: right; font-weight: bold; }
        .calc-row.total { border-top: 2px dashed #aaa; padding-top: 10px; margin-top: 5px; }
        .total-display { font-size: 1.4rem; font-weight: 900; color: var(--primary); }

        /* Signature */
        .sig-box { margin-top: 20px; text-align: center; }
        canvas { border: 2px dashed #ccc; border-radius: 10px; background: white; touch-action: none; width: 100%; height: 150px; cursor: crosshair; }
        .btn-clear { background: #999; color: white; border: none; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; margin-top: 5px; cursor: pointer; }

        /* Actions */
        .actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; gap: 10px; justify-content: space-around; z-index: 100; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-pdf { background: var(--primary); color: white; }
        .btn-email { background: var(--secondary); color: white; }
        .btn:active { transform: scale(0.98); }
        
        .upload-box { margin-top: 20px; padding: 15px; border: 2px dashed #ccc; border-radius: 10px; text-align: center; background: #fff; }
    </style>
</head>
<body>

<div class="header">
    <h2>Tagesbericht / Abrechnung</h2>
</div>

<div class="container">
    <div class="card">
        <div class="form-group" style="margin-bottom:10px;">
            <label>Fahrer Name (Name) <span class="required-mark">*</span></label>
            <input type="text" id="driverName" placeholder="...">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Kennzeichen (Plate) <span class="required-mark">*</span></label>
                <input type="text" id="plate" placeholder="ZH-...">
            </div>
            <div class="form-group">
                <label>Datum (Date)</label>
                <input type="date" id="date">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="table-header">
            <span class="lbl-firma">Firma / Kunde</span>
            <span class="lbl-betrag">Betrag (CHF)</span>
        </div>
        
        <div id="rows-container">
            </div>
    </div>

    <div class="calc-box">
        <div class="calc-row">
            <label>Brutto Total:</label>
            <span id="bruttoSum">0.00</span>
        </div>
        <div class="calc-row">
            <label style="color:#d32f2f;">- Tanken (Fuel):</label>
            <input type="number" id="tanken" placeholder="0.00" oninput="calcTotal()">
        </div>
        <div class="calc-row">
            <label style="color:#d32f2f;">- Auszahlung (Cash):</label>
            <input type="number" id="auszahlung" placeholder="0.00" oninput="calcTotal()">
        </div>
        <div class="calc-row total">
            <label>NETTO TOTAL:</label>
            <div class="total-display"><span id="nettoSum">0.00</span> CHF</div>
        </div>
    </div>

    <div class="upload-box">
        <label>üì∏ Foto / Beleg (Optional)</label>
        <input type="file" id="attachment" accept="image/*,application/pdf" style="display:block; margin:10px auto;">
    </div>

    <div class="sig-box">
        <label style="font-weight:bold; color:#555;">Unterschrift (Signature) <span class="required-mark">*</span></label>
        <canvas id="sigCanvas"></canvas>
        <button class="btn-clear" onclick="clearSig()">L√∂schen</button>
    </div>
</div>

<div class="actions">
    <button class="btn btn-pdf" onclick="sharePDF()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
        PDF / Share
    </button>
    <button class="btn btn-email" onclick="sendEmail()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        Senden
    </button>
</div>

<script>
    let isSigned = false; // To track if signature exists

    // 1. Generate 15 Rows
    const rowsContainer = document.getElementById('rows-container');
    for (let i = 1; i <= 15; i++) {
        rowsContainer.innerHTML += `
        <div class="entry-row">
            <div class="entry-num">${i}.</div>
            <input type="text" class="inp-firma" id="firma_${i}" placeholder="...">
            <input type="number" class="inp-betrag" id="betrag_${i}" placeholder="0.00" oninput="calcTotal()">
        </div>`;
    }

    // 2. Set Date to Today
    document.getElementById('date').valueAsDate = new Date();

    // 3. Calculation Logic
    function calcTotal() {
        let sum = 0;
        for (let i = 1; i <= 15; i++) {
            let val = parseFloat(document.getElementById(`betrag_${i}`).value);
            if (!isNaN(val)) sum += val;
        }
        document.getElementById('bruttoSum').innerText = sum.toFixed(2);

        let tanken = parseFloat(document.getElementById('tanken').value) || 0;
        let auszahlung = parseFloat(document.getElementById('auszahlung').value) || 0;

        let netto = sum - tanken - auszahlung;
        document.getElementById('nettoSum').innerText = netto.toFixed(2);
        return { sum, tanken, auszahlung, netto };
    }

    // 4. Signature Logic
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        ctx.scale(ratio, ratio);
    }
    window.onresize = resizeCanvas;
    setTimeout(resizeCanvas, 100);

    // Drawing Events
    function startDraw(e) {
        e.preventDefault();
        drawing = true;
        isSigned = true; // Mark as signed
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    }
    function moveDraw(e) {
        e.preventDefault();
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }
    function endDraw() { drawing = false; }
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    canvas.addEventListener('touchstart', startDraw, {passive: false});
    canvas.addEventListener('touchmove', moveDraw, {passive: false});
    canvas.addEventListener('touchend', endDraw);
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    canvas.addEventListener('mouseup', endDraw);

    function clearSig() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        isSigned = false;
    }

    // Validation Function
    function validateForm() {
        const name = document.getElementById('driverName').value.trim();
        const plate = document.getElementById('plate').value.trim();
        
        if (!name) { alert("Bitte Fahrer Name eingeben!"); return false; }
        if (!plate) { alert("Bitte Kennzeichen eingeben!"); return false; }
        if (!isSigned) { alert("Bitte unterschreiben!"); return false; }
        return true;
    }

    // 5. PDF Generation & Share
    async function generatePDFObject() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const primaryColor = [26, 35, 126];

        // Header
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 20, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text("TAGESBERICHT / ABRECHNUNG", 105, 13, { align: "center" });

        // Info
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        const name = document.getElementById('driverName').value || "-";
        const plate = document.getElementById('plate').value || "-";
        const date = document.getElementById('date').value || "-";

        doc.text(`Fahrer: ${name}`, 14, 30);
        doc.text(`Kennzeichen: ${plate}`, 14, 36);
        doc.text(`Datum: ${date}`, 150, 30);

        // Table Data
        let tableData = [];
        for (let i = 1; i <= 15; i++) {
            let f = document.getElementById(`firma_${i}`).value;
            let b = document.getElementById(`betrag_${i}`).value;
            if (f || b) {
                tableData.push([i, f, b ? parseFloat(b).toFixed(2) : "-"]);
            }
        }

        doc.autoTable({
            startY: 45,
            head: [['#', 'Firma / Kunde', 'Betrag (CHF)']],
            body: tableData,
            theme: 'striped',
            headStyles: { fillColor: primaryColor },
            columnStyles: { 2: { halign: 'right' } }
        });

        let finalY = doc.lastAutoTable.finalY + 10;
        const calcs = calcTotal();
        doc.setFontSize(11);
        doc.text(`Brutto Total:`, 140, finalY);
        doc.text(`${calcs.sum.toFixed(2)}`, 190, finalY, { align: "right" });
        
        doc.setTextColor(200, 0, 0);
        doc.text(`- Tanken:`, 140, finalY + 6);
        doc.text(`${calcs.tanken.toFixed(2)}`, 190, finalY + 6, { align: "right" });
        doc.text(`- Auszahlung:`, 140, finalY + 12);
        doc.text(`${calcs.auszahlung.toFixed(2)}`, 190, finalY + 12, { align: "right" });

        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text(`NETTO: ${calcs.netto.toFixed(2)} CHF`, 190, finalY + 22, { align: "right" });

        const sigImg = canvas.toDataURL('image/png');
        if (isSigned) {
            doc.text("Unterschrift:", 14, finalY + 30);
            doc.addImage(sigImg, 'PNG', 14, finalY + 32, 50, 25);
        }

        return doc;
    }

    async function sharePDF() {
        if (!validateForm()) return;

        const doc = await generatePDFObject();
        const blob = doc.output('blob');
        const file = new File([blob], "Abrechnung.pdf", { type: "application/pdf" });

        // Try Native Share
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'Abrechnung',
                    text: 'Hier ist meine Abrechnung.'
                });
            } catch (err) {
                console.log("Share failed/cancelled", err);
            }
        } else {
            // Fallback for Desktop
            doc.save("Abrechnung.pdf");
        }
    }

    // 6. Send Email Logic
    async function sendEmail() {
        if (!validateForm()) return;

        const btn = document.querySelector('.btn-email');
        const oldText = btn.innerHTML;
        btn.innerHTML = "Senden...";
        btn.disabled = true;

        const name = document.getElementById('driverName').value;
        const date = document.getElementById('date').value;

        try {
            const doc = await generatePDFObject();
            const pdfBlob = doc.output('blob');
            
            const formData = new FormData();
            // *** YOUR ACCESS KEY HERE ***
            formData.append("access_key", "817b5739-ed89-4340-9674-57d210b081b7"); 
            
            formData.append("subject", `Abrechnung: ${name} - ${date}`);
            formData.append("message", `Fahrer: ${name}\nDatum: ${date}\nNetto: ${document.getElementById('nettoSum').innerText} CHF`);
            formData.append("attachment", pdfBlob, `Abrechnung_${name}.pdf`);

            const fileInput = document.getElementById('attachment');
            if(fileInput.files.length > 0) {
                formData.append("attachment2", fileInput.files[0]);
            }

            const res = await fetch("https://api.web3forms.com/submit", { method: "POST", body: formData });
            if (res.ok) {
                alert("‚úÖ Erfolgreich gesendet!");
                // clearSig(); // Optional: reset after send
            } else {
                alert("‚ùå Fehler beim Senden.");
            }
        } catch (e) {
            alert("Fehler.");
        }
        btn.innerHTML = oldText;
        btn.disabled = false;
    }
</script>

</body>
</html>
