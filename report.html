<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #1a237e; --secondary: #2e7d32; --bg: #f0f2f5; --border: #ced4da; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* APP LAYOUT STRUCTURE */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* FIXED HEADER */
        .app-header { 
            background: var(--primary); color: white; padding: 15px; text-align: center; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10;
        }
        .app-header h2 { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }

        /* SCROLLABLE CONTENT */
        .app-content { 
            flex-grow: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; padding-bottom: 20px;
        }

        /* FIXED FOOTER */
        .app-footer { 
            background: white; padding: 12px 15px; border-top: 1px solid #ddd; flex-shrink: 0; display: flex; gap: 10px; padding-bottom: env(safe-area-inset-bottom);
        }

        /* CARD STYLES */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }

        /* INPUTS */
        label { display: block; font-size: 0.85rem; color: #555; margin-bottom: 6px; font-weight: 600; }
        input, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            font-size: 16px; 
            background: #fff;
            font-family: inherit;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; background: #f8f9fa; }
        
        .form-row-top { display: flex; gap: 10px; }
        .form-col { flex: 1; }

        /* TABLE FIXES */
        .table-header { 
            display: flex; gap: 8px; margin-bottom: 8px; font-size: 0.8rem; color: #777; font-weight: bold; align-items: center;
        }
        .th-num { width: 20px; } 
        .th-firma { flex: 1; }
        .th-betrag { width: 95px; text-align: right; }

        .entry-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .entry-num { font-size: 0.8rem; color: #999; width: 20px; font-weight: bold; text-align: center; }
        
        .inp-firma { flex: 1; min-width: 0; }
        .inp-betrag { 
            width: 95px; 
            text-align: right; 
            font-weight: bold; 
            color: var(--primary);
            padding: 12px 10px;
        }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* CALCULATION BOX */
        .calc-box { background: #e8eaf6; padding: 15px; border-radius: 10px; }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; font-size: 0.95rem; }
        .calc-row input { width: 100px; padding: 8px; text-align: right; font-weight: bold; }
        .calc-row.total { border-top: 1px solid #bdc3c7; padding-top: 12px; margin-top: 5px; }
        .total-text { font-size: 1.3rem; font-weight: 900; color: var(--primary); }

        /* SIGNATURE & NOTE */
        .sig-container { border: 2px dashed #bbb; border-radius: 10px; background: #fff; height: 130px; position: relative; }
        canvas { width: 100%; height: 100%; touch-action: none; cursor: crosshair; }
        .sig-clear { position: absolute; bottom: 8px; right: 8px; background: #eee; border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; color: #555; font-weight: bold; }

        /* BUTTONS */
        .btn { flex: 1; border: none; border-radius: 12px; padding: 14px; font-size: 1rem; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: opacity 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn:active { opacity: 0.8; transform: scale(0.99); }
        .btn-pdf { background: var(--primary); }
        .btn-email { background: var(--secondary); }

        .upload-wrapper { text-align: center; border: 2px dashed #ddd; padding: 15px; border-radius: 10px; margin-top: 10px; background: #fafafa; }
    </style>
</head>
<body>

    <div class="app-header">
        <h2>Tagesbericht</h2>
    </div>

    <div class="app-content">
        
        <div class="card">
            <div style="margin-bottom: 15px;">
                <label>Fahrer Name *</label>
                <input type="text" id="driverName" placeholder="Name des Fahrers">
            </div>
            <div class="form-row-top">
                <div class="form-col">
                    <label>Kennzeichen *</label>
                    <input type="text" id="plate" placeholder="ZH-...">
                </div>
                <div class="form-col">
                    <label>Datum</label>
                    <input type="date" id="date">
                </div>
            </div>
        </div>

        <div class="card" style="padding-top: 10px;">
            <div class="table-header">
                <span class="th-num">#</span>
                <span class="th-firma">Firma / Kunde</span>
                <span class="th-betrag">Betrag (CHF)</span>
            </div>
            <div id="rows-container">
                </div>
        </div>

        <div class="card">
            <div class="calc-box">
                <div class="calc-row">
                    <span>Brutto Total:</span>
                    <span id="bruttoSum" style="font-weight:bold;">0.00</span>
                </div>
                <div class="calc-row">
                    <span style="color:#c62828;">- Tanken (Fuel):</span>
                    <input type="number" inputmode="decimal" id="tanken" placeholder="0.00" oninput="calcTotal()">
                </div>
                <div class="calc-row">
                    <span style="color:#c62828;">- Auszahlung:</span>
                    <input type="number" inputmode="decimal" id="auszahlung" placeholder="0.00" oninput="calcTotal()">
                </div>
                <div class="calc-row total">
                    <span>NETTO:</span>
                    <span class="total-text"><span id="nettoSum">0.00</span> CHF</span>
                </div>
            </div>
        </div>

        <div class="card">
            <label>üì∏ Foto / Beleg (Optional)</label>
            <div class="upload-wrapper">
                <input type="file" id="attachment" accept="image/*,application/pdf" style="width:100%;">
            </div>

            <label style="margin-top:20px;">Bemerkungen (Note)</label>
            <textarea id="driverNote" rows="2" placeholder="Z.B. Stau, Extra Service..."></textarea>

            <label style="margin-top:20px;">Unterschrift *</label>
            <div class="sig-container">
                <canvas id="sigCanvas"></canvas>
                <button class="sig-clear" onclick="clearSig()">L√∂schen</button>
            </div>
        </div>

    </div>

    <div class="app-footer">
        <button class="btn btn-pdf" onclick="sharePDF()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
            PDF
        </button>
        <button class="btn btn-email" onclick="sendEmail()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Senden
        </button>
    </div>

<script>
    let isSigned = false;

    const rowsContainer = document.getElementById('rows-container');
    for (let i = 1; i <= 15; i++) {
        rowsContainer.innerHTML += `
        <div class="entry-row">
            <div class="entry-num">${i}.</div>
            <input type="text" class="inp-firma" id="firma_${i}" placeholder="Firma...">
            <input type="number" inputmode="decimal" class="inp-betrag" id="betrag_${i}" placeholder="0.00" oninput="calcTotal()">
        </div>`;
    }

    document.getElementById('date').valueAsDate = new Date();

    function calcTotal() {
        let sum = 0;
        for (let i = 1; i <= 15; i++) {
            let val = parseFloat(document.getElementById(`betrag_${i}`).value);
            if (!isNaN(val)) sum += val;
        }
        document.getElementById('bruttoSum').innerText = sum.toFixed(2);

        let tanken = parseFloat(document.getElementById('tanken').value) || 0;
        let auszahlung = parseFloat(document.getElementById('auszahlung').value) || 0;

        let netto = sum - tanken - auszahlung;
        document.getElementById('nettoSum').innerText = netto.toFixed(2);
        return { sum, tanken, auszahlung, netto };
    }

    // Signature
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function startDraw(e) {
        e.preventDefault();
        drawing = true;
        isSigned = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";
    }
    function moveDraw(e) {
        e.preventDefault();
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }
    function endDraw() { drawing = false; }
    
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    canvas.addEventListener('touchstart', startDraw, {passive: false});
    canvas.addEventListener('touchmove', moveDraw, {passive: false});
    canvas.addEventListener('touchend', endDraw);
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    canvas.addEventListener('mouseup', endDraw);

    function clearSig() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        isSigned = false;
    }

    function validateForm() {
        const name = document.getElementById('driverName').value.trim();
        const plate = document.getElementById('plate').value.trim();
        if (!name) { alert("Bitte Fahrer Name eingeben!"); return false; }
        if (!plate) { alert("Bitte Kennzeichen eingeben!"); return false; }
        if (!isSigned) { alert("Bitte unterschreiben!"); return false; }
        return true;
    }

    // PDF Generation
    async function generatePDFObject() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const primaryColor = [26, 35, 126];

        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 20, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text("TAGESBERICHT / ABRECHNUNG", 105, 13, { align: "center" });

        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        const name = document.getElementById('driverName').value || "-";
        const plate = document.getElementById('plate').value || "-";
        const date = document.getElementById('date').value || "-";
        // Get Note
        const note = document.getElementById('driverNote').value || "-";

        doc.text(`Fahrer: ${name}`, 14, 30);
        doc.text(`Kennzeichen: ${plate}`, 14, 36);
        doc.text(`Datum: ${date}`, 150, 30);

        let tableData = [];
        for (let i = 1; i <= 15; i++) {
            let f = document.getElementById(`firma_${i}`).value;
            let b = document.getElementById(`betrag_${i}`).value;
            if (f || b) {
                tableData.push([i, f, b ? parseFloat(b).toFixed(2) : "-"]);
            }
        }

        doc.autoTable({
            startY: 45,
            head: [['#', 'Firma / Kunde', 'Betrag (CHF)']],
            body: tableData,
            theme: 'striped',
            headStyles: { fillColor: primaryColor, halign: 'left' },
            // FIX: Align Column 2 (Betrag) to Right for HEADER and BODY
            columnStyles: { 
                0: { cellWidth: 10 },
                1: { },
                2: { halign: 'right' } 
            }
        });

        let finalY = doc.lastAutoTable.finalY + 10;
        const calcs = calcTotal();
        doc.setFontSize(11);
        doc.text(`Brutto Total:`, 140, finalY);
        doc.text(`${calcs.sum.toFixed(2)}`, 190, finalY, { align: "right" });
        
        doc.setTextColor(200, 0, 0);
        doc.text(`- Tanken:`, 140, finalY + 6);
        doc.text(`${calcs.tanken.toFixed(2)}`, 190, finalY + 6, { align: "right" });
        doc.text(`- Auszahlung:`, 140, finalY + 12);
        doc.text(`${calcs.auszahlung.toFixed(2)}`, 190, finalY + 12, { align: "right" });

        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text(`NETTO: ${calcs.netto.toFixed(2)} CHF`, 190, finalY + 22, { align: "right" });

        // Add Note to PDF
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("Bemerkungen:", 14, finalY + 30);
        doc.setTextColor(80, 80, 80);
        // Split text if too long
        const splitNote = doc.splitTextToSize(note, 100); 
        doc.text(splitNote, 14, finalY + 35);
        doc.setTextColor(0, 0, 0);

        // Add Signature (positioned lower to make room for note)
        const sigImg = canvas.toDataURL('image/png');
        if (isSigned) {
            doc.text("Unterschrift:", 14, finalY + 55);
            doc.addImage(sigImg, 'PNG', 14, finalY + 58, 50, 25);
        }

        return doc;
    }

    async function sharePDF() {
        if (!validateForm()) return;

        const doc = await generatePDFObject();
        const blob = doc.output('blob');
        const file = new File([blob], "Abrechnung.pdf", { type: "application/pdf" });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'Abrechnung',
                    text: 'Tagesbericht'
                });
            } catch (err) { console.log("Share skipped"); }
        } else {
            doc.save("Abrechnung.pdf");
        }
    }

    async function sendEmail() {
        if (!validateForm()) return;

        const btn = document.querySelector('.btn-email');
        const oldText = btn.innerHTML;
        btn.innerHTML = "Senden...";
        btn.disabled = true;

        const name = document.getElementById('driverName').value;
        const date = document.getElementById('date').value;
        const note = document.getElementById('driverNote').value;

        try {
            const doc = await generatePDFObject();
            const pdfBlob = doc.output('blob');
            
            const formData = new FormData();
            // *** YOUR ACCESS KEY HERE ***
            formData.append("access_key", "817b5739-ed89-4340-9674-57d210b081b7"); 
            
            formData.append("subject", `Abrechnung: ${name} - ${date}`);
            // Added Note to Email Message
            formData.append("message", `Fahrer: ${name}\nDatum: ${date}\nBemerkungen: ${note}\n\nNetto: ${document.getElementById('nettoSum').innerText} CHF`);
            formData.append("attachment", pdfBlob, `Abrechnung_${name}.pdf`);

            const fileInput = document.getElementById('attachment');
            if(fileInput.files.length > 0) {
                formData.append("attachment2", fileInput.files[0]);
            }

            const res = await fetch("https://api.web3forms.com/submit", { method: "POST", body: formData });
            if (res.ok) {
                alert("‚úÖ Erfolgreich gesendet!");
            } else {
                alert("‚ùå Fehler beim Senden.");
            }
        } catch (e) { alert("Fehler."); }
        btn.innerHTML = oldText;
        btn.disabled = false;
    }
</script>

</body>
</html>
