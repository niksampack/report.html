<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NIK Driver Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #1a237e; --secondary: #2e7d32; --bg: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* Header */
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; border-bottom: 5px solid var(--secondary); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header h1 { margin: 0; font-size: 1.5rem; font-weight: 800; letter-spacing: 1px; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        
        /* Driver Info Card */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-group { flex: 1; }
        .form-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 4px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; -webkit-appearance: none; }
        
        /* Table Style */
        .entry-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .entry-num { font-size: 0.8rem; color: #999; width: 20px; text-align: right; }
        .inp-firma { flex: 2; }
        .inp-betrag { flex: 1; text-align: right; font-weight: bold; }

        /* Calculation Section */
        .calc-box { background: #e8f5e9; padding: 15px; border-radius: 12px; border: 1px solid #c8e6c9; }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .calc-row label { font-weight: 600; color: var(--primary); }
        .calc-row input { width: 100px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; text-align: right; font-weight: bold; }
        .calc-row.total { border-top: 2px dashed #aaa; padding-top: 10px; margin-top: 5px; }
        .total-display { font-size: 1.4rem; font-weight: 900; color: var(--primary); }

        /* Signature */
        .sig-box { margin-top: 20px; text-align: center; }
        canvas { border: 2px dashed #ccc; border-radius: 10px; background: white; touch-action: none; width: 100%; height: 150px; }
        .btn-clear { background: #999; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-top: 5px; }

        /* Actions */
        .actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; gap: 10px; justify-content: space-around; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-pdf { background: var(--primary); color: white; }
        .btn-email { background: var(--secondary); color: white; }
        
        .upload-box { margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; text-align: center; background: white; }
    </style>
</head>
<body>

<div class="header">
    <h1>NIK TRANSPORT</h1>
    <div style="font-size: 0.8rem; opacity: 0.9;">Tagesbericht / Abrechnung</div>
</div>

<div class="container">
    <div class="card">
        <div class="form-group" style="margin-bottom:10px;">
            <label>Fahrer Name (Driver)</label>
            <input type="text" id="driverName" placeholder="Name...">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Kennzeichen (Plate)</label>
                <input type="text" id="plate" placeholder="ZH-...">
            </div>
            <div class="form-group">
                <label>Datum (Date)</label>
                <input type="date" id="date">
            </div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-top:0; color:var(--primary);">Kunden / Firmen</h3>
        <div id="rows-container">
            </div>
    </div>

    <div class="calc-box">
        <div class="calc-row">
            <label>Brutto Total:</label>
            <span id="bruttoSum">0.00</span>
        </div>
        <div class="calc-row">
            <label style="color:#d32f2f;">- Tanken (Fuel):</label>
            <input type="number" id="tanken" placeholder="0.00" oninput="calcTotal()">
        </div>
        <div class="calc-row">
            <label style="color:#d32f2f;">- Auszahlung (Cash):</label>
            <input type="number" id="auszahlung" placeholder="0.00" oninput="calcTotal()">
        </div>
        <div class="calc-row total">
            <label>NETTO TOTAL:</label>
            <div class="total-display"><span id="nettoSum">0.00</span> CHF</div>
        </div>
    </div>

    <div class="upload-box">
        <label>üì∏ Foto / Beleg (Optional)</label>
        <input type="file" id="attachment" accept="image/*,application/pdf" style="display:block; margin:10px auto;">
    </div>

    <div class="sig-box">
        <label style="font-weight:bold; color:#555;">Unterschrift (Signature)</label>
        <canvas id="sigCanvas"></canvas>
        <button class="btn-clear" onclick="clearSig()">L√∂schen</button>
    </div>
</div>

<div class="actions">
    <button class="btn btn-pdf" onclick="generatePDF()">
        üìÑ PDF / Share
    </button>
    <button class="btn btn-email" onclick="sendEmail()">
        üìß Senden
    </button>
</div>

<script>
    // 1. Generate 15 Rows
    const rowsContainer = document.getElementById('rows-container');
    for (let i = 1; i <= 15; i++) {
        rowsContainer.innerHTML += `
        <div class="entry-row">
            <div class="entry-num">${i}.</div>
            <input type="text" class="inp-firma" id="firma_${i}" placeholder="Firma...">
            <input type="number" class="inp-betrag" id="betrag_${i}" placeholder="0.00" oninput="calcTotal()">
        </div>`;
    }

    // 2. Set Date to Today
    document.getElementById('date').valueAsDate = new Date();

    // 3. Calculation Logic
    function calcTotal() {
        let sum = 0;
        // Sum 15 rows
        for (let i = 1; i <= 15; i++) {
            let val = parseFloat(document.getElementById(`betrag_${i}`).value);
            if (!isNaN(val)) sum += val;
        }
        document.getElementById('bruttoSum').innerText = sum.toFixed(2);

        // Deductions
        let tanken = parseFloat(document.getElementById('tanken').value) || 0;
        let auszahlung = parseFloat(document.getElementById('auszahlung').value) || 0;

        let netto = sum - tanken - auszahlung;
        document.getElementById('nettoSum').innerText = netto.toFixed(2);
        return { sum, tanken, auszahlung, netto };
    }

    // 4. Signature Logic
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    // Resize canvas for high DPI
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        ctx.scale(ratio, ratio);
    }
    window.onresize = resizeCanvas;
    setTimeout(resizeCanvas, 100);

    // Touch events
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
    }, {passive: false});

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineTo(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
        ctx.stroke();
    }, {passive: false});

    canvas.addEventListener('touchend', () => drawing = false);

    // Mouse events (for desktop testing)
    canvas.addEventListener('mousedown', (e) => {
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
    });
    canvas.addEventListener('mousemove', (e) => {
        if (!drawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
    });
    canvas.addEventListener('mouseup', () => drawing = false);

    function clearSig() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // 5. PDF Generation
    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Colors
        const primaryColor = [26, 35, 126]; // #1a237e

        // Header
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 20, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text("NIK TRANSPORT - ABRECHNUNG", 105, 13, { align: "center" });

        // Info
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        const name = document.getElementById('driverName').value || "-";
        const plate = document.getElementById('plate').value || "-";
        const date = document.getElementById('date').value || "-";

        doc.text(`Fahrer: ${name}`, 14, 30);
        doc.text(`Kennzeichen: ${plate}`, 14, 36);
        doc.text(`Datum: ${date}`, 150, 30);

        // Table Data
        let tableData = [];
        for (let i = 1; i <= 15; i++) {
            let f = document.getElementById(`firma_${i}`).value;
            let b = document.getElementById(`betrag_${i}`).value;
            if (f || b) {
                tableData.push([i, f, b ? parseFloat(b).toFixed(2) : "-"]);
            }
        }

        // AutoTable
        doc.autoTable({
            startY: 45,
            head: [['#', 'Firma / Kunde', 'Betrag (CHF)']],
            body: tableData,
            theme: 'striped',
            headStyles: { fillColor: primaryColor },
            columnStyles: { 2: { halign: 'right' } }
        });

        let finalY = doc.lastAutoTable.finalY + 10;

        // Totals
        const calcs = calcTotal();
        doc.setFontSize(11);
        doc.text(`Brutto Total:`, 140, finalY);
        doc.text(`${calcs.sum.toFixed(2)}`, 190, finalY, { align: "right" });
        
        doc.setTextColor(200, 0, 0); // Red
        doc.text(`- Tanken:`, 140, finalY + 6);
        doc.text(`${calcs.tanken.toFixed(2)}`, 190, finalY + 6, { align: "right" });
        doc.text(`- Auszahlung:`, 140, finalY + 12);
        doc.text(`${calcs.auszahlung.toFixed(2)}`, 190, finalY + 12, { align: "right" });

        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text(`NETTO: ${calcs.netto.toFixed(2)} CHF`, 190, finalY + 22, { align: "right" });

        // Add Signature
        const sigImg = canvas.toDataURL('image/png');
        if (sigImg && sigImg.length > 500) { // Check if not empty (rough check)
            doc.text("Unterschrift:", 14, finalY + 30);
            doc.addImage(sigImg, 'PNG', 14, finalY + 32, 50, 25);
        }

        return doc;
    }

    // Helper: Trigger PDF download/share
    async function sharePDF() {
        const doc = await generatePDF();
        doc.save("Abrechnung.pdf");
    }

    // 6. Send Email Logic
    async function sendEmail() {
        const btn = document.querySelector('.btn-email');
        const oldText = btn.innerText;
        btn.innerText = "Senden...";
        btn.disabled = true;

        const name = document.getElementById('driverName').value;
        const date = document.getElementById('date').value;
        
        if(!name) { alert("Bitte Namen eingeben!"); btn.innerText=oldText; btn.disabled=false; return; }

        try {
            // Generate PDF Blob
            const doc = await generatePDF();
            const pdfBlob = doc.output('blob');
            
            const formData = new FormData();
            // *** YOUR ACCESS KEY HERE ***
            formData.append("access_key", "817b5739-ed89-4340-9674-57d210b081b7"); 
            
            formData.append("subject", `Abrechnung: ${name} - ${date}`);
            formData.append("message", `Hallo,\n\nanbei die t√§gliche Abrechnung von ${name}.\nDatum: ${date}\n\nNetto: ${document.getElementById('nettoSum').innerText} CHF`);
            
            // Attach PDF
            formData.append("attachment", pdfBlob, `Abrechnung_${name}_${date}.pdf`);

            // Attach Photo if selected
            const fileInput = document.getElementById('attachment');
            if(fileInput.files.length > 0) {
                formData.append("attachment2", fileInput.files[0]);
            }

            const res = await fetch("https://api.web3forms.com/submit", { method: "POST", body: formData });
            
            if (res.ok) {
                alert("‚úÖ Erfolgreich gesendet!");
            } else {
                alert("‚ùå Fehler beim Senden.");
            }

        } catch (e) {
            console.error(e);
            alert("Fehler.");
        }
        btn.innerText = oldText;
        btn.disabled = false;
    }
</script>

</body>

</html>
